<!DOCTYPE html>
<html>
<head>
    <title>Backbone Website</title>
    <link rel="stylesheet" href="styles.css" />
    <script type="text/javascript" src="libs/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="libs/handlebars.js"></script>
    <script type="text/javascript" src="libs/underscore.js"></script>
    <script type="text/javascript" src="libs/backbone.js"></script>

</head>
<body>
<div class="logger-container">
    <ul id="logger">

    </ul>
</div>

<div class="wrapper">
    <div class="header">

    </div>
    <div class="content-wrapper">
        <div class="navigation">

        </div>

        <div class="content">

        </div>
    </div>
</div>


<script type="text/template" id="headerTemplate">
    <div>
        <div class="welcome">Hi <strong>{{userName}}</strong>,
            <a href="logout.html">Logout</a>
        </div>
        <a href="http://google.com">
            <img src="images/logo.png" height="75" />
        </a>
    </div>
    <div>
        You are in: {{pageName}} Page
    </div>
</script>


<script type="text/template" id="navOptionTemplate">
    <li>
        <a href="#{{id}}">{{name}}</a>
    </li>
</script>


<script type="text/javascript">
    /*
     Properties
     model
     collection
     tagName
     className
     el
     $el (jquery el)
     events map


     Methods
     initialize
     this.$
     render
     */

</script>
<script type="text/javascript">

    //View Definitions


    var HeaderView = Backbone.View.extend({
        render: function () {
            var templateFunction = Handlebars.compile($('#headerTemplate').html());
            this.$el.html(templateFunction(this.model.toJSON()));
        }
    });


    var NavigationView = Backbone.View.extend({
        tagName: 'ul',
        className: 'left-nav',
        el: '.navigation',
        render: function () {
            var navTemplate = Handlebars.compile($('#navOptionTemplate').html())
            this.collection.each(function (model) {
                this.$el.append(navTemplate(model.toJSON()))
            }, this)
        }
    });

    var ContentView = Backbone.View.extend({
        render: function () {
            this.$el.html('this is the content view')
        },
        el: '.content'
    })


    var WebsiteRouter = Backbone.Router.extend({
        routes: {
            '': 'index',
            ':pageId': 'loadPage'
        },
        index: function () {
            this.loadPage('home');
        },
        loadPage: function (pageId) {

            var contentEl = $('.content');
            contentEl.empty();

            appModel.set('pageId', pageId);

            switch (pageId) {
                case 'users':
                    var userCollection = new UserCollection();
                    var userView = new UserView({
                        collection: userCollection
                    });
                    userView.render();
                    userView.$el.appendTo(contentEl);
                    userCollection.fetch();
                    break;

                default:
                    var templateRequest = $.ajax('templates/' + pageId + '.html')
                    templateRequest.done(function (htmlString) {
                        contentEl.html(htmlString);
                    })
                    break;
            }
        }
    })

    var UserCollection = Backbone.Collection.extend({
        url: 'data/users.json',
        parse: function (data) {
            return data.results;
        }
    })

    var UserItemView = Backbone.View.extend({
        className: 'user',
        tagName: 'tr',
        render: function () {
            var _this = this;
            var templateRequest = $.ajax('templates/user.html')
            templateRequest.done(function (htmlString) {
                var templateFunction = Handlebars.compile(htmlString);
                _this.$el.html(templateFunction(_this.model.toJSON()));
            })
        }
    })

    var UserView = Backbone.View.extend({
        tagName: 'table',
        className: 'user-list',
        initialize: function () {
            this.listenTo(this.collection, 'add', this.addUser);
        },
        render: function () {
            var columns = ['name', 'picture', 'email', 'phone']
            var tr = $('<tr></tr>');
            _.each(columns, function (head) {
                tr.append('<th>' + head + '</th>');
            })

            this.$el.append(tr);
        },
        addUser: function (model) {
            var userItemView = new UserItemView({
                model: model
            })
            userItemView.render();
            userItemView.$el.appendTo(this.$el);
        }
    })


    var appModel = new Backbone.Model({
        userName: 'Ravi Hamsa'
    })
    var header = new HeaderView({
        model: appModel,
        el: '.header'

    });
    header.render();


    var navOptionCollection = new Backbone.Collection([
        {
            id: 'home',
            name: 'Home'
        },
        {
            id: 'about_us',
            name: 'About Us'
        },
        {
            id: 'users',
            name: 'Users'
        },
        {
            id: 'contact_us',
            name: 'Contact US'
        }
    ]);


    var navigation = new NavigationView({
        collection: navOptionCollection
    });
    navigation.render();


    var contentView = new ContentView();
    contentView.render();


    appModel.on('change:pageId', function (model, pageId) {
        var navOption = navOptionCollection.get(pageId);
        var pageName = navOption.get('name');
        appModel.set('pageName', pageName);
        header.render();
    })


    var router = new WebsiteRouter();
    Backbone.history.start();

</script>
<script type="text/javascript" src="logger.js"></script>
</body>
</html>